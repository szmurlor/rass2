{% extends "base.html" %}

{% block content %}
<style>
    #id-header-readonly .form-group > .control-label {
        padding-top: 2px;!important;
    }
    #id-header-readonly .form-group .form-control-static {
        padding-top: 2px;!important;
        min-height: 24px;!important;
    }
    #id-header-readonly .form-group {
        margin-bottom: 5px;
    }

    .col1 { width: 2em; max-width: 2em;}
    .col2 { width: 11em; max-width: 11em;}
    .col3 { width: 20em; max-width: 20em;}
    .col4 { width: 20em; max-width: 20em;}
    .col5 { width: 10em; max-width: 10em;}
    .table {word-wrap: break-word;}
</style>

  <div class="pull-right"><small>Ostatnia modyfikacja: {{dataset.date_modified|datetime}} przez {{dataset.user_modified.username}}</small></div>
  <h1>Zbiór danych</h1>

{% macro render_upload_new(file_type, parent_uid) -%}
    <a href="#" id="id-show-upload-{{file_type.name}}" onclick="show_upload_file('{{file_type.name}}'); return false;">(Prześlij nowy plik)</a>
    <div id="id-upload-file-{{file_type.name}}" class="panel panel-default" style="display: none;" >
      <div class="panel-body">
        <form action="/data/upload/" enctype="multipart/form-data" method="POST">
            <input type="hidden" name="dataset_id" value="{{ dataset.id }}" />
            <input type="hidden" name="parent_id" value="{{ parent_uid }}" />
            <input type="hidden" name="file_type" value="{{ file_type.name }}" />
            <div>
                <div class="form-group">
                    <input type="file" name="file"/>
                    <p class="help-block">Proszę wgrywać: {{file_type.formats}}</p>
                </div>
                <div class="form-group">
                    <label for="id-upload-file-comment-{{file_type.name}}">Opcjonalny komentarz</label>
                    <input class="form-control" type="text" name="description" id="id-upload-file-comment-{{file_type.name}}" maxlength="512" />
                </div>
                <input type="submit" formmethod="POST" name="upload_{{file_type.name}}" class="btn btn-success" value="Wyślij" />
                <a href="#" onclick="hide_upload_file('{{file_type.name}}'); return false;">(Anuluj)</a>
            </div>
        </form>
      </div>
    </div>
    <script language="JavaScript">
        function show_upload_file(name) {
            $('#id-upload-file-'+name).show();
            $('#id-show-upload-'+name).hide();
        }
        function hide_upload_file(name) {
            $('#id-upload-file-'+name).hide();
            $('#id-show-upload-'+name).show();
        }
    </script>
{% endmacro %}

{% macro render_inner_inner_files(file_type, dataset, parent_uid) %}
{% for file_type_inner in dataset.type.file_types_list(parent=file_type.name) %}
        <div class="row">
           <div class="col-sm-12">
                <h4 title="{{ file_type_inner.formats }}">{{ file_type_inner.desc }}</h4>
           </div>
        </div>
        <div class="row">
            <div class="col-sm-12">
                {% if not file_type_inner.only_one or dataset.files_by_type(file_type_inner.name, parent_uid = parent_uid)|length == 0 %}
                    {{ render_upload_new(file_type_inner, parent_uid) }}
                {% endif %}

                <table class="table">

                {% if not file_type_inner.only_one and dataset.files_by_type(file_type_inner.name, parent_uid = parent_uid)|length > 0 -%}
                {% endif %}
                <tbody>
                {% set idx = 1 %}
                {% for file in dataset.files_by_type(file_type_inner.name, parent_uid = parent_uid) %}
                <tr>
                    {% if not file_type_inner.only_one -%}
                        <td class="col1">{{idx}}</td>
                    {% endif -%}
                    <td class="col2">
                        <a href="/fs/{{file.uid}}">(Pobierz)</a>
                        <a href="/data/delete/{{file.uid}}">(Usuń)</a>
                    </td>
                    <td class="col3"><b>{{file.name}}</b></td>
                    <td class="col4">{{file.description}}</td>
                    <td class="col5">{{file.stored_at|datetime}} przez {{file.stored_by.username}}</td>
                </tr>
                {% set idx = idx + 1 %}
                {% endfor %}
                </tbody>
                </table>
            </div>
        </div>
    {% endfor %}
{%- endmacro %}

{% macro render_inner_files(file_type, dataset, parent_uid) %}
{% for file_type_inner in dataset.type.file_types_list(parent=file_type.name) %}
        <div class="row">
           <div class="col-sm-12">
                <h4 title="{{ file_type_inner.formats }}">{{ file_type_inner.desc }}</h4>
           </div>
        </div>
        <div class="row">
            <div class="col-sm-12">
                {% if not file_type_inner.only_one or dataset.files_by_type(file_type_inner.name, parent_uid = parent_uid)|length == 0 %}
                    {{ render_upload_new(file_type_inner, parent_uid) }}
                {% endif %}

                <table class="table">

                {% if not file_type_inner.only_one and dataset.files_by_type(file_type_inner.name, parent_uid = parent_uid)|length > 0 -%}
{#
                    <thead><tr>
                        {% if not file_type_inner.only_one -%}
                            <th>L.p.</th>
                        {% endif -%}
                        <th>Operacje</th>
                        <th>Nazwa oryginalna</th>
                        <th>Opcjonalny komentarz</th>
                        <th>Ostatnia modyfikacja</th>
                    </tr></thead>
#}
                {% endif %}
                <tbody>
                {% set idx = 1 %}
                {% for file in dataset.files_by_type(file_type_inner.name, parent_uid = parent_uid) %}
                <tr>
                    {% if not file_type_inner.only_one -%}
                        <td class="col1">{{idx}}</td>
                    {% endif -%}
                    <td class="col2">
                        <a href="/fs/{{file.uid}}">(Pobierz)</a>
                        <a href="/data/delete/{{file.uid}}">(Usuń)</a>
                    </td>
                    <td class="col3"><b>{{file.name}}</b></td>
                    <td class="col4">{{file.description}}</td>
                    <td class="col5">{{file.stored_at|datetime}} przez {{file.stored_by.username}}</td>
                </tr>
                {% if dataset.type.file_types_list(parent=file_type_inner.name)|length > 0  %}
                    <tr>
                        <td></td>
                        <td colspan="4">
                            <div class="panel panel-default">
                                <div class="panel-body">
                                    {{- render_inner_inner_files(file_type_inner, dataset, file.uid) -}}
                                </div>
                            </div>
                        </td>
                    </tr>
                {% endif %}
                {% set idx = idx + 1 %}
                {% endfor %}
                </tbody>
                </table>
            </div>
        </div>
    {% endfor %}
{%- endmacro %}

{% macro form_control_static(label, value) -%}
<div class="form-group">
    <label class="control-label col-sm-2">{{label}}</label>
    <div class="col-sm-6">
        <p class="form-control-static">{{value}}</p>
    </div>
</div>
{% endmacro -%}

{% macro input_text(label, value, name, id, info) -%}
<div class="form-group">
    <label class="control-label col-sm-2" for="{{id}}">{{label}}</label>
    <div class="col-sm-6">
        <input type="text" class="form-control" id="{{id}}" name="{{name}}" value="{{ value }}"/>
        <small>{{info}}</small>
    </div>
</div>
{% endmacro -%}

  <form class="form-horizontal" action="/data/update" method="POST">
      <input type="hidden" name="dataset_id" value="{{dataset.id}}" />

    <script language="JavaScript">
        function show_header_edit() {
            $('#id-header-readonly').hide();
            $('#id-header-edit').show();
            $('#id-date-created').focus();
        }
        function hide_header_edit() {
            $('#id-header-readonly').show();
            $('#id-header-edit').hide();
        }
    </script>

      {# To jest nagłówek zbioru danych w trybie READONLY #}
      <div id="id-header-readonly">
          <div class="form-group">
            <div class="col-sm-8"></div>
            <div class="col-sm-2">
                <a href="#" onclick="show_header_edit();">(Zmień)</a>
            </div>
          </div>
          {{form_control_static('Data utworzenia:', dataset.date_created|date )}}
          {{form_control_static('Nazwa:', dataset.name )}}
          {{form_control_static('Właściciel:', dataset.user_created.username )}}
          {{form_control_static('Krótkie uwagi:', dataset.short_notes )}}
      </div>

      {# To jest nagłówek zbioru danych w trybie EDIT #}
      <div id="id-header-edit" style="display: none">
          <div class="form-group">
            <div class="col-sm-8"></div>
            <div class="col-sm-2">
            </div>
          </div>

          {{input_text('Data utworzenia:', dataset.date_created|date, 'date_created', 'id-date-created')}}
          {{input_text('Nazwa:', dataset.name, 'name', 'id-name')}}
          {{form_control_static('Właściciel:', dataset.user_created.username)}}
          {{input_text('Krótkie uwagi:', dataset.short_notes, 'short_notes', 'id-short-notes')}}

          <div class="form-group">
            <div class="col-sm-2"></div>
            <div class="col-sm-6">
                <button type="submit" name="save_header" class="btn btn-success">Zapisz</button>
                <a href="#" onclick="hide_header_edit()">(Anuluj)</a>
            </div>
          </div>
      </div>

        <script language="JavaScript">
            function change_notes() {
                $('#id-notes-readonly').hide();
                $('#id-notes-edit').show();
                $('#id-long-notes').focus();
            }
            function hide_notes() {
                $('#id-notes-readonly').show();
                $('#id-notes-edit').hide();
            }
        </script>
      {# To jest wyświetlenie notatek w trybie READONLY.
         Notatki te zostaną przepasowane przez Markdown.
         JavaScript jest dołączony w skrypcie poniżej.
      #}
      <div id="id-notes-readonly">
          <div class="form-group">
            <label class="control-label col-sm-2">Dłuższy komentarz / notatki:</label>
            <div class="col-sm-6">
                {% if dataset.long_notes != None -%}
                    <div id="id-long-notes-readonly"></div>
                {% else -%}
                    <div>-</div>
                {% endif -%}

              <script lang="javascript">
                var converter = new showdown.Converter(),
                html = converter.makeHtml(`{{ dataset.long_notes }}`);
                $("#id-long-notes-readonly").html(html);
              </script>

            </div>
            <div class="col-sm-1">
                <a href="#" onclick="change_notes()">(Zmień)</a>
            </div>
        </div>
      </div>


      {# To są notatki w trybie EDIT. #}
      <div id="id-notes-edit" style="display: none;">
          <div class="form-group">
            <label class="control-label col-sm-2" for="id-long-notes">Dłuższy komentarz / notatki:</label>
            <div class="col-sm-6">
                <textarea id="id-long-notes" cols="100" rows="20" name="long_notes">{{dataset.long_notes}}</textarea>
                <p class="help-block">Tekst może być wpisywany zgodnie ze składnią <a target="_blank" href="https://github.com/adam-p/markdown-here/wiki/Markdown-Cheatsheet">Markdown</a></p>
            </div>
        </div>
        <div class="form-group">
            <div class="col-sm-2"></div>
            <button name="save" type="submit" class="btn btn-success">Zapisz</button>
            <a href="#" onclick="hide_notes()">(Anuluj)</a>
        </div>
      </div>
    </form>


{% for file_type in dataset.type.file_types_list(parent=None) %}
<div class="panel panel-default">
  <div class="panel-heading"><h4>{{ file_type.desc }}</h4></div>
  <div class="panel-body">
    <div class="col-sm-12">
{#
           <p>Proszę wgrywać: {{ file_type.formats }}</p>
#}

            {% if (not file_type.only_one) or dataset.files_by_type(file_type.name)|length == 0 %}
                {{ render_upload_new(file_type) }}
            {% endif %}

            <table class="table">
                {% if not file_type.only_one and dataset.files_by_type(file_type.name)|length > 0 -%}
{#
                <thead><tr>
                    <th>L.p.</th>
                    <th>Operacje</th>
                    <th>Nazwa oryginalna</th>
                    <th>Opcjonalny komentarz</th>
                    <th>Ostatnia modyfikacja</th>
                </tr></thead>
#}
                {% endif -%}
                <tbody>
                {% set idx = 1 %}
                {% for file in dataset.files_by_type(file_type.name) %}
                <tr>
                    {% if not file_type.only_one -%}
                        <td class="col1">{{idx}}</td>
                    {% endif -%}
                    <td class="col2">
                        <a href="/fs/{{file.uid}}">(Pobierz)</a>
                        <a href="/data/delete/{{file.uid}}">(Usuń)</a>
                    </td>
                    <td class="col3"><b>{{file.name}}</b></td>
                    <td class="col4">{{file.description}}</td>
                    <td class="col5">{{file.stored_at|datetime}} przez {{file.stored_by.username}}</td>
                </tr>
                {% if dataset.type.file_types_list(parent=file_type.name)|length > 0 %}
                    <tr>
                        <td>
                        </td>
                        <td colspan="4">
                            <div class="panel panel-default">
                                <div class="panel-body">
                                    {{ render_inner_files(file_type, dataset, file.uid) }}
                                </div>
                            </div>
                        </td>
                    </tr>
                {% endif  %}
                {% set idx = idx + 1 %}
                {% endfor %}
                </tbody>
            </table>
        </div>

  </div>
</div>
{% endfor %}
{% endblock %}

